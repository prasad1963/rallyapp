<!DOCTYPE html>
<html>
	<head>
		<title>Custom Rally App for metrics and reporting</title>
		<script src="/apps/2.0/sdk.js"></script>
		<script>
			/* 
				Rally variables
				Current Workspace ID: __WORKSPACE_OID__
				Current Project ID: __PROJECT_OID__
				Current User ID:  __USER_OID__
				Curent User Name: __USER_NAME__
				Project Scoping Up: __PROJECT_SCOPING_UP__
				Project Scoping Down: __PROJECT_SCOPING_DOWN__
			*/

			/* Setting up Page Element variables and attributes */
			var labels = {
				errors : {
					datesBackwards : 'Please update your dates so as to not be reverse chronological order.',
					idListEmpty : 'Please include at least one formatted ID.',
					queryEmpty : 'You have submitted an empty query.',
					queryParensMismatch : 'You have a mismatch of opening and closing parenthesis in your query.',
					queryQuotesMismatch : 'You have a mismatch of double-quotes in your query.',
					storyIdInvalidIdWithId : ' is not a valid Rally story ID.',
					storyIdInvalidTypeWithId : ' is not a valid Rally story type.',
					storyStatePickerBackwards : 'Your states are in reverse order.',
					storyStatePickerDuplicate : 'You must select different states.',
					zeroCols : 'Please select at least one column.',
					zeroResults : 'Your search returned no results.'
				},
				messages : {
					gettingStateChanges : 'Collecting User Story state changes...',
					gettingStoryDetails : 'Collecting User Story details...',
					gettingUserStories : 'Collecting User Story items...',
					renderingBurndownData : 'Creating burndown data chart...'
				}
			};

			/* Rally App component initialization */
			Rally.onReady(function() {
				Rally.launchApp('CustomApp',{ name: 'Custom Data Export App' });
			});

			/* Rally App component definitions */
			Ext.define('CustomApp',{
				/* extend the base Rally app class */
				extend : 'Rally.app.App',

				/* Component class/type  */
				componentCls : 'app',

				/* What to do when the app launches */
				launch : function() {
					/* Custom HTML elements in App frame */
					this.add({
						items : [
							{ xtype : 'container', id : 'report-selection-container' },
							{ xtype : 'container', id : 'report-input-container' },
							{ xtype : 'container', id : 'report-output-container' }
						]
					});

					/* Load core UI elements and corresponding events */
					var initialRadioSelection = {
						xtype : 'form',
						title : 'Choose your desired report',
						id : 'report-type',
						items : [
							{
								xtype : 'radiogroup',
								defaultType : 'radiofield',
								defaults : {
									flex : 1
								},
								layout : 'hbox',
								items : [
									{
										boxLabel : 'Accepted Defects Report',
										afterSubTpl : 'Details for Accepted/Closed defects within a date range.',
										name : 'request-type',
										inputValue : 'AcceptedDefectsReport',
										padding : 10
									},
									{
										boxLabel : 'Burndown Chart and Data Export',
										afterSubTpl : 'Generate a burndown chart and exportable grid of hours remaining, based off tasks generated via query.',
										name : 'request-type',
										inputValue : 'BurndownData',
										padding : 10
									},
									{
										boxLabel : 'Task Generation',
										afterSubTpl : 'Create a task import template for multiple stories/defects, with owner pre-assigned to the assigned developer.',
										name : 'request-type',
										inputValue : 'TaskCreation',
										padding : 10
									},
									{
										boxLabel : 'User Story State Changes',
										afterSubTpl : 'See the various change states for user stories and defects within a date range.',
										name : 'request-type',
										inputValue : 'StoryStateChanges',
										padding : 10
									},
									{
										boxLabel : 'User Story State Snapshot',
										afterSubTpl : 'View the states of stories on a given date/time.',
										name : 'request-type',
										inputValue : 'StoryStateSnapshot',
										padding : 10
									}
									/*,
									{
										boxLabel : 'Days Between for Stories and Defects',
										afterSubTpl : 'Kanban flow by story.',
										name : 'request-type',
										inputValue : 'DaysBetween'
									},
									{
										boxLabel : 'Defect Count By Group',
										afterSubTpl : 'Lorem Ipsum',
										name : 'request-type',
										inputValue : 'DefectCountByGroup',
										disabled : true
									},
									{
										boxLabel : 'Code Review time spent',
										afterSubTpl : 'Lorem Ipsum',
										name : 'request-type',
										inputValue : 'CodeReview',
										disabled : true
									}*/
								],
								listeners : {
									change : function(field,newValue,oldValue){
										toggleReportOptions(field,newValue,oldValue);
									}
								}
							}
						]
					};
					renderContent(initialRadioSelection,'report-selection-container');
				},

				component : {
					/*
						DatePicker
						Rally Drop Down
						ColumnPicker
						Submit button
						ExportCSV
						QueryBuilder
						Checkbox (nix)
						TextArea (nix)
						TimePicker
					*/
					artifactSearchBox : function(options){
						var defaults = {
							xtype : 'rallyartifactsearchcombobox',
							storeConfig : {
								models : ['Defect','UserStory']
							}
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					/* Create query builder */
					basicQueryBuilder : function(){
						// Set up initial Query field, and Add Parameter button
						var _init = {
							xtype : 'container',
							id : 'QueryBuilderAdd',
							items : [
								{
									xtype : 'panel',
									items : [
										this.queryField({
											readOnly : true,
											id : 'GeneratedQueryField',
											emptyText : 'Add parameters to see your query update here'
										}),
										{
											xtype : 'fieldcontainer',
											fieldLabel : 'Manual Query',
											afterLabelTpl : '<a href="https://help.rallydev.com/grid-queries" target="_blank">Query format tips</a>',
											defaultType : 'checkboxfield',
											items : [
												{
													name : 'ManualQuery',
													inputValue : true,
													id : 'ManualQueryCheck',
													listeners : {
														change : function(checkbox,newValue,oldValue,eOpts){
															Ext.getCmp('GeneratedQueryField').setReadOnly(oldValue);
															if(oldValue){ updateGeneratedQueryItems.query('QueryBuilderParams'); }
														}
													}
												}
											]
										}
									]
								},
								{
									xtype : 'container',
									id : 'QueryBuilderParams',
									listeners : {
										afterrender : function(){
											Ext.getCmp('QueryBuilderParams').add(baseTemplate);
											updateGeneratedQueryItems.remover('QueryBuilderParams');
											// updateGeneratedQueryItems.adder('QueryBuilderParams');
										}
									}
								}
							]
						};

						// Base template for each added parameter
						var baseTemplate = {
							xtype : 'container',
							baseCls : 'QuerySetWrapper',
							items : [
								{
									xtype : 'rallybutton',
									text : 'X',
									cls : 'QueryParamDelete',
									hiddenName : 'remover',
									listeners : {
										click : function(button,e,eOpts){
											var parent = button.up('container');
											parent.destroy();
											updateGeneratedQueryItems.operator('QueryBuilderParams');
											updateGeneratedQueryItems.query('QueryBuilderParams');
											updateGeneratedQueryItems.remover('QueryBuilderParams');
											// updateGeneratedQueryItems.adder('QueryBuilderParams');
										}
									}
								},
								{
									xtype : 'rallyfieldcombobox',
									model : 'UserStory',
									listeners : {
										change : function(list,newValue,oldValue,eOpts){
											var model = 'UserStory';
											var field = newValue;
											var artifactType = 'hierarchicalrequirement';
											var parent = list.up('container');

											var schemaType = getModelType(artifactType,field);

											// Remove Operand and Value items
											while(list.nextSibling() !== null){ list.nextSibling().destroy(); }

											// Get and render new components
											var componentList = getModelComponents(schemaType,field);
											if(componentList){
												parent.add(componentList);
												updateGeneratedQueryItems.operator('QueryBuilderParams');
												// updateGeneratedQueryItems.adder('QueryBuilderParams');
											}else{
												return false;
											}
										}
									}
								}
							]
						};
						function getModelType(artifact,value){
							var rallyModelObj = Rally.data.wsapi.ModelFactory._modelCache;
							var artifactObj = rallyModelObj['rally.domain.v2.0.project.' + __PROJECT_OID__ + '.' + artifact];
							var typeDefs = artifactObj.typeDef.Attributes;
							for(var i=0;i<typeDefs.length;i++){
								if(typeDefs[i].ElementName == value){
									return typeDefs[i].AttributeType;
								}
							}
						}
						function getModelComponents(key,field){
							if(key === 'undefined'){
								// Dependencies
								return false;
							}
							var rallyApp = Rally.getApp('CustomApp');

							Ext.regModel('Operand',{ fields: [{ type : 'string', name : 'val' }] });
							var operatorStore = Ext.create('Ext.data.Store',{
								model: 'Operand',
								data: [{ 'val' : 'AND' },{ 'val' : 'OR' }]
							});
							var booleanStore = Ext.create('Ext.data.Store',{
								model: 'Operand',
								data: [{ 'val' : '=' },{ 'val' : '!=' }]
							});
							var containsStore = Ext.create('Ext.data.Store',{
								model: 'Operand',
								data: [{ 'val' : 'contains' },{ 'val' : '!contains' }]
							});
							var symbolStore = Ext.create('Ext.data.Store',{
								model: 'Operand',
								data: [{ 'val' : '=' },{ 'val' : '<' },{ 'val' : '<=' },{ 'val' : '>=' },{ 'val' : '>' },{ 'val' : '!=' }]
							});

							switch(key.toLowerCase()){
								case 'boolean' :
									var operand = Ext.create('Ext.form.field.ComboBox',{
										displayField: 'val',
										store: booleanStore,
										queryMode: 'local'
									});
									var value = rallyApp.component.fieldValueDropDown({ field : field });
									break;
								case 'collection' :
									/* Attachements,Changesets,Children,Defects,Discussion,Milestones,Predecessors,Successors,Tasks,TestCases*/
									switch(field){
										case 'Tags' : /* NEED TO DO: This creates an obj in the Search Query */
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: containsStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.tagChooser();
											break;
										default :
											return false;
											break;
									}
									break;
								case 'date' :
									var operand = Ext.create('Ext.form.field.ComboBox',{
										displayField: 'val',
										store: symbolStore,
										queryMode: 'local'
									});
									var value = rallyApp.component.dateField();
									break;
								case 'integer' :
									switch(field){
										case 'FormattedID' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: booleanStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.artifactSearchBox();
											break;
										default :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: symbolStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.textField();
											break;
									}
									break;
								case 'object' : 
									switch(field){
										case 'Blocker' :
											// Blocker
											return false;
											break;
										case 'Iteration' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: booleanStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.iterationSearchBox();
											break;
										case 'Owner' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: booleanStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.userSearchBox();
											break;
										case 'Parent' :
											// Parent
											return false;
											break;
										case 'Project' :
											// Project
											return false;
											break;
										case 'Release' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: booleanStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.releaseSearchBox();
											break;
										case 'RevisionHistory' :
											// Revision History
											return false;
											break;
										case 'Subscription' :
											// Subscription
											return false;
											break;
										case 'Workspace' :
											// Workspace
											return false;
											break;
										default :
											return false;
											break;
										}
									break;
								case 'quantity' :
									var operand = Ext.create('Ext.form.field.ComboBox',{
										displayField: 'val',
										store: symbolStore,
										queryMode: 'local'
									});
									var value = rallyApp.component.textField();
									break;
								case 'raw' :
									// ObjectUUID
									return false;
									break;
								case 'state' :
									var operand = Ext.create('Ext.form.field.ComboBox',{
										displayField: 'val',
										store: symbolStore,
										queryMode: 'local'
									});
									var value = rallyApp.component.fieldValueDropDown({ field : field });
									break;
								case 'string' :
									switch(field){
										case 'Name' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: containsStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.textField();
											break;
										case 'c_RequestingClients' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: containsStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.textField();
											break;
										case 'ScheduleStatePrefix' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: containsStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.textField();
											break;
										case 'VersionId' :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: containsStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.textField();
											break;
										default :
											var operand = Ext.create('Ext.form.field.ComboBox',{
												displayField: 'val',
												store: symbolStore,
												queryMode: 'local'
											});
											var value = rallyApp.component.fieldValueDropDown({
												field : field
											});
											break;
									}
									break;
								case 'text' :
									var operand = Ext.create('Ext.form.field.ComboBox',{
										displayField: 'val',
										store: containsStore,
										queryMode: 'local'
									});
									var value = rallyApp.component.textField({
										emptyText : 'Enter text here'
									});
									break;
								default :
									console.log(key);
									return false;
							}
							if(operand && value){
								var operator = Ext.create('Ext.form.field.ComboBox',{
									displayField: 'val',
									store: operatorStore,
									queryMode: 'local',
									disabled : true,
									hiddenName : 'operator'
								});
								var addParameter = {
									xtype : 'rallybutton',
									text : '+',
									hiddenName : 'adder',
									listeners : {
										click : function(button,e,eOpts){
											Ext.getCmp('QueryBuilderParams').add(baseTemplate);
											updateGeneratedQueryItems.remover('QueryBuilderParams');
											// updateGeneratedQueryItems.adder('QueryBuilderParams');
										}
									}
								};
								operand.on('afterrender',function(element){
									var firstItem = element.getStore().getAt(0);
									element.setValue(firstItem.data.val);
								});
								operand.on('change',function(element){ updateGeneratedQueryItems.query('QueryBuilderParams'); });
								operator.on('change',function(element){ updateGeneratedQueryItems.query('QueryBuilderParams'); });
								value.listeners = { change : function(element){ updateGeneratedQueryItems.query('QueryBuilderParams'); } };
								return [operand,value,operator,addParameter];
							}
						}
						var updateGeneratedQueryItems = {
							adder : function(wrapper){
								var addParamButtons = Ext.getCmp(wrapper).query('container [hiddenName="adder"]');
							//	for(var i=0;i<addParamButtons.length;i++){ addParamButtons[i].disable(); }
							//	addParamButtons[addParamButtons.length-1].enable();
							//	console.log(addParamButtons);
							},
							remover : function(wrapper){
								var removalButtons = Ext.getCmp(wrapper).query('container [hiddenName="remover"]');
								for(var i=0;i<removalButtons.length;i++){ removalButtons[i].enable(); }
								if(removalButtons.length <= 1){ removalButtons[0].disable(); }
							},
							operator : function(wrapper){
								var lineItems = Ext.getCmp(wrapper).query('container');
								for(var i=0;i<lineItems.length;i++){
									var lineItemCmp = lineItems[i].query();
									for(var j=0;j<lineItemCmp.length;j++){
										if( lineItemCmp[j].hiddenName == 'operator'){
											var operator = lineItemCmp[j];
										}
									}
									if(i == lineItems.length-1){
										operator.setValue('');
										operator.disable();
									}else{
										operator.enable();
									}
								}
							},
							query : function(wrapper){
								if(Ext.getCmp('ManualQueryCheck').getValue()){ return false; }
								var itemArray = [];
								var itemWrapper = Ext.getCmp(wrapper).query('container');
								for(var i=0;i<itemWrapper.length;i++){
									var lineArray = [];
									var lineWrapper = itemWrapper[i].query();
									for(var j=1;j<lineWrapper.length-1;j++){
										var val = lineWrapper[j].getValue();
										lineArray.push(val);
									}
									itemArray.push(lineArray);
								}
								var queryArray = [];
								var queryResult = '';
								for(var k=0;k<itemArray.length;k++){
									var opening = '';
									if(k == 0){
										for(var p=0;p<itemArray.length;p++){ opening += '('; }
									}else{
										opening += '(';
									}
									var key = itemArray[k][0].replace('c_','');
									var operand = itemArray[k][1];
									var value = (itemArray[k][2] instanceof Date) ? utilityFn.dates.toISO(itemArray[k][2]) : itemArray[k][2];
									var closing = (k == 0) ? ')' : '))';
									var operator = (itemArray[k][3] == null) ? '' : ' ' + itemArray[k][3] + ' ';
									queryArray.push( opening + key + ' ' + operand + ' "' + value + '"' + closing + operator);
									queryResult = queryArray.join('');
								}
								Ext.getCmp('GeneratedQueryField').setValue(queryResult.trim());
							}
						};
						return _init;
					},

					columnPicker : function(options){
						var defaults = {
							xtype : 'rallyfieldpicker',
							alwaysExpanded : false,
							autoExpand : false
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Create date fields for range selection
					dateField : function(options){
						var defaults = {
							xtype : 'rallydatefield',
							value : new Date(),
							allowBlank : false,
							format : 'D, M d, Y'
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Drop down list for Field Pairs
					fieldValueDropDown : function(options){
						var defaults = {
							xtype : 'rallyfieldvaluecombobox',
							model : 'UserStory',
							field : 'ScheduleState'
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Drop down list for Iterations
					iterationSearchBox : function(options){
						var defaults = {
							xtype : 'rallyiterationcombobox'
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Create query field for custom query
					queryField : function(options){
						var defaults = {
							xtype : 'rallytextfield',
							baseCls : 'custom-search-query-value'
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Drop down list for Releases
					releaseSearchBox : function(options){
						var defaults = {
							xtype : 'rallyreleasecombobox'
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Create submit button for search query
					submit : function(altText){
						var reportType = Ext.getCmp('report-type').getForm().getValues()['request-type'];
						var submitButton = {
							xtype : 'rallybutton',
							text : (altText) ? altText : 'Submit',
							listeners : {
								click : function(){
									prepareReportQuery(reportType);
								}
							},
						};
						return submitButton;
					},

					// Tag picker
					tagChooser : function(options){
						var defaults = {
							xtype : 'rallytagpicker',
							autoExpand : true
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Basic Text Field
					textField : function(options){
						var defaults = {
							xtype : 'textfield'
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// Time picker
					timeField : function(options){
						var defaults = {
							xtype : 'timepicker'

						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					},

					// User search box
					userSearchBox : function(options){
						var defaults = {
							xtype : 'rallyusersearchcombobox',
							project : '/project/' + __PROJECT_OID__
						}
						var completeItemDetails = {};
						for (var key in defaults) { completeItemDetails[key] = defaults[key]; }
						for (var key in options) { completeItemDetails[key] = options[key]; }
						return completeItemDetails;
					}
				},

				/* Rally functinos for creating app objects */
				reportDetails : {
					AcceptedDefectsReport : function(){
						var rallyApp = Rally.getApp('CustomApp');
						var openingDate = rallyApp.component.dateField({
							fieldLabel : 'Opening Date',
							id : 'OpeningDatePicker'
						});
						var closingDate = rallyApp.component.dateField({
							fieldLabel : 'Closing Date',
							id : 'ClosingDatePicker'
						});
						var colDefaultsValues = ['CreationDate','ClosedDate','FormattedID','Name','Release','Resolution'];
						var columnPicker = rallyApp.component.columnPicker({
							id : 'ColumnPicker',
							modelTypes : ['Defect'],
							fieldLabel : 'Select columns',
							listeners : {
								added : function(picker,container,pos,eOpts){
									picker.setValue(colDefaultsValues);
								},
								change : function(picker,newValue,oldValue,eOpts){
									var values = picker.getValue();
									var output = { html : '<ul>' }
									for(var i=0;i<values.length;i++){
										output.html += '<li>' + values[i].data.displayName + '</li>';
									}
									output.html += '</ul>';
									renderContent(output,'ColumnPickerResults');
								},
								selectionchange : function(picker,values,eOpts){
									var output = { html : '<ul>' }
									for(var i=0;i<values.length;i++){
										output.html += '<li>' + values[i].data.displayName + '</li>';
									}
									output.html += '</ul>';
									renderContent(output,'ColumnPickerResults');
								}
							}
						});
						var selections = {
							cls : 'colWrapper',
							items : [
								{
									xtype : 'container',
									cls : 'colNarrow',
									items : [
										openingDate,
										closingDate,
										{
											xtype : 'rallyfieldvaluecombobox',
											model : 'Defect',
											field : 'Priority',
											fieldLabel :'Priority:',
											id : 'RallyField_Priority'
										},
										{
											xtype : 'rallyfieldvaluecombobox',
											model : 'Defect',
											field : 'Environment',
											fieldLabel : 'Environment:',
											id : 'RallyField_Environment'
										},
										{
											xtype : 'panel',
											title : 'Selected Fields',
											id : 'ColumnPickerResults'
										}
									]
								},
								{
									xtype : 'container',
									cls : 'colMid',
									items : [
										columnPicker
									]
								}
							]
						};
						var submitButton = rallyApp.component.submit();
						return [selections,submitButton];
					},
					BurndownData : function(){
						var rallyApp = Rally.getApp('CustomApp');
						var openingDate = rallyApp.component.dateField({
							fieldLabel : 'Opening Date',
							id : 'OpeningDatePicker'
						});
						var closingDate = rallyApp.component.dateField({
							fieldLabel : 'Closing Date',
							id : 'ClosingDatePicker'
						});
						var weekendCheckbox = {
							xtype : 'container',
							items: [
								{
									xtype : 'radiogroup',
									defaultType : 'radiofield',
									defaults : { flex : 1 },
									fieldLabel : 'Query for',
									id : 'BurndownQueryType',
									items : [
										{
											boxLabel : 'Defects and Stories',
											name : 'query-type',
											inputValue : 'storiesAndDefects',
											padding : 10,
											checked : true
										},
										{
											boxLabel : 'Defects',
											name : 'query-type',
											inputValue : 'defects',
											padding : 10
										},
										{
											boxLabel : 'Stories',
											name : 'query-type',
											inputValue : 'stories',
											padding : 10
										},
										{
											boxLabel : 'Tasks',
											name : 'query-type',
											inputValue : 'tasks',
											padding : 10
										}
									]
								},
								{
									xtype : 'fieldcontainer',
									fieldLabel : 'Include Weekends',
									defaultType : 'checkboxfield',
									items : [
										{
											name : 'WeekendPicker',
											inputValue : true,
											id : 'WeekendPicker'
										}
									]
								}
							]
						};
						var queryBuilder = rallyApp.component.basicQueryBuilder();
						var submitButton = rallyApp.component.submit();
						return [openingDate,closingDate,weekendCheckbox,queryBuilder,submitButton];
					},
					StoryStateChanges : function(){
						var rallyApp = Rally.getApp('CustomApp');
						var openingDate = rallyApp.component.dateField({
							fieldLabel : 'Opening Date',
							id : 'OpeningDatePicker'
						});
						var closingDate = rallyApp.component.dateField({
							fieldLabel : 'Closing Date',
							id : 'ClosingDatePicker'
						});
						var colDefaultsValues = ['FormattedID','Name','c_KanbanState','Release'];
						var columnPicker = rallyApp.component.columnPicker({
							id : 'ColumnPicker',
							modelTypes : ['Defect','UserStory'],
							fieldLabel : 'Selected Columns',
							listeners : {
								added : function(picker,container,pos,eOpts){
									picker.setValue(colDefaultsValues);
								},
								change : function(picker,newValue,oldValue,eOpts){
									var values = picker.getValue();
									var output = { html : '<ul>' }
									for(var i=0;i<values.length;i++){
										output.html += '<li>' + values[i].data.displayName + '</li>';
									}
									output.html += '</ul>';
									renderContent(output,'ColumnPickerResults');
								},
								selectionchange : function(picker,values,eOpts){
									var output = { html : '<ul>' }
									for(var i=0;i<values.length;i++){
										output.html += '<li>' + values[i].data.displayName + '</li>';
									}
									output.html += '</ul>';
									renderContent(output,'ColumnPickerResults');
								}
							}
						});
						var selections = {
							cls : 'colWrapper',
							items : [
								{
									xtype : 'container',
									cls : 'colNarrow',
									items : [
										openingDate,
										closingDate,
										{
											xtype : 'rallyfieldvaluecombobox',
											model : 'UserStory',
											fieldLabel : 'From:',
											id : 'RallyField_StateFrom',
											field : 'c_KanbanState'
										},
										{
											xtype : 'rallyfieldvaluecombobox',
											model : 'UserStory',
											fieldLabel : 'To:',
											id : 'RallyField_StateTo',
											field : 'c_KanbanState'
										},
										{
											xtype : 'panel',
											title : 'Selected columns',
											id : 'ColumnPickerResults'
										}
									]
								},
								{
									xtype : 'container',
									cls : 'colMid',
									items : [
										columnPicker
									]
								}
							]
						};
						var queryBuilder = rallyApp.component.basicQueryBuilder();
						var submitButton = rallyApp.component.submit();
						return [selections,queryBuilder,submitButton];
					},
					StoryStateSnapshot : function(){
						var rallyApp = Rally.getApp('CustomApp');
						var datePicker = rallyApp.component.dateField({
							fieldLabel : 'Date and time',
							id : 'DatePicker',
							style : { float : 'left' },
							value : utilityFn.dates.toEvening(new Date),
							listeners : {
								select : function(element,date,eOpts){
									// Get H/M/S from hiddenfield
									var hiddenDateTime = new Date( Ext.getCmp('HiddenDateTimeObj').getValue() );
									var hours = hiddenDateTime.getHours();
									var minutes = hiddenDateTime.getMinutes();
									var seconds = 0;

									// Set H/M/S date in calendar date
									date.setHours(hours);
									date.setMinutes(minutes);
									date.setSeconds(seconds);

									// Update hiddenfield
									Ext.getCmp('HiddenDateTimeObj').setValue(date);
								}
							}
						});
						var timeResult = rallyApp.component.textField({
							id : 'TimeResult',
							width : 80,
							readOnly : true,
							style : { float : 'left', marginLeft : '10px' }
						});
						var hiddenDateTimeField = {
							xtype : 'hiddenfield',
							id : 'HiddenDateTimeObj',
							value : utilityFn.dates.toEvening(new Date)
						};
						var timePicker = rallyApp.component.timeField({
							format : 'g:i A',
							id : 'TimePicker',
							increment : 30,
							listeners : {
								select : function(element,record,eOpts){
									// Set display item in text field
									Ext.getCmp('TimeResult').setValue(record.data.disp);

									// Get date from hiddenfield
									var newDateTime = new Date( Ext.getCmp('HiddenDateTimeObj').getValue() );

									// Set new H/M/S date in hiddenfield
									newDateTime.setHours( record.data.date.getHours() );
									newDateTime.setMinutes( record.data.date.getMinutes() );
									newDateTime.setSeconds(0);
									Ext.getCmp('HiddenDateTimeObj').setValue(newDateTime);
								}
							},
							height : 100,
							width : 150,
							style : { marginLeft : '105px' }
						});
						var colDefaultsValues = ['FormattedID','Name','c_KanbanState','Release'];
						var columnPicker = rallyApp.component.columnPicker({
							id : 'ColumnPicker',
							modelTypes : ['Defect','UserStory'],
							fieldLabel : 'Selected Columns',
							listeners : {
								added : function(picker,container,pos,eOpts){
									picker.setValue(colDefaultsValues);
								},
								change : function(picker,newValue,oldValue,eOpts){
									var values = picker.getValue();
									var output = { html : '<ul>' }
									for(var i=0;i<values.length;i++){
										output.html += '<li>' + values[i].data.displayName + '</li>';
									}
									output.html += '</ul>';
									renderContent(output,'ColumnPickerResults');
								},
								selectionchange : function(picker,values,eOpts){
									var output = { html : '<ul>' }
									for(var i=0;i<values.length;i++){
										output.html += '<li>' + values[i].data.displayName + '</li>';
									}
									output.html += '</ul>';
									renderContent(output,'ColumnPickerResults');
								}
							}
						});
						var selections = {
							cls : 'colWrapper',
							items : [
								{
									xtype : 'container',
									cls : 'colNarrow',
									items : [
										{
											xtype : 'container',
											items : [ datePicker,timeResult,hiddenDateTimeField ],
											style : {
												overflow : 'hidden'
											}
										},
										timePicker,
										{
											xtype : 'panel',
											title : 'Selected columns',
											id : 'ColumnPickerResults'
										}
									]
								},
								{
									xtype : 'container',
									cls : 'colMid',
									items : [
										columnPicker
									]
								}
							]
						};
						var queryBuilder = rallyApp.component.basicQueryBuilder();
						var submitButton = rallyApp.component.submit();
						return [selections,queryBuilder,submitButton];
					},
					TaskCreation : function(){
						var rallyApp = Rally.getApp('CustomApp');

						var formattedData = createStoreData.taskDefaults();

						var gridData = Ext.create('Ext.data.Store',{
							storeId : 'TaskTemplateStore',
							fields : formattedData.fields,
							data : { 'items' : formattedData.values },
							proxy : {
								type : 'memory',
								reader : {
									type : 'json',
									root : 'items'
								}
							}
						});
						var gridPanel = Ext.create('Ext.grid.Panel',{
							title : 'Base Task Template',

							store : 'TaskTemplateStore',
							columns : {
								items : formattedData.headers,
								defaults : {
									flex : 1,
									hideable : false
								}
							},
							selType : 'cellmodel',
							plugins : [ Ext.create('Ext.grid.plugin.CellEditing',{ clicksToEdit : 1 }) ],
							viewConfig : {
								enableTextSelection : false
							}
						});
						var storyItemBox = {
							xtype : 'textareafield',
							id : 'StoryIdList',
							cls : 'textarea',
							grow : false,
							fieldLabel : 'Comma-Separated Carriage Return-separated list items',
							emptyText : 'e.g.\n\tUS1901,US2124,DE12182\nor\n\tUS1901\n\tUS2124\n\tDE12182'
						};
						var submitButton = rallyApp.component.submit('Create CSV');
						return [gridPanel,storyItemBox,submitButton];
					}
				}
			});

			// Function for checking the API results for errors and alerting them
			function apiResultErrorCheck(returnObj,callback){
				if(returnObj.QueryResult.Errors.length > 0){
					var errorMessageList = utilityFn.errorsListHtml( returnObj.QueryResult.Errors.unique() );
					messageFn.alertBox(errorMessageList);
					return false;
				}else{
					callback();
				}
			}
			// Object conversions
			function apiResultCleanup(dataObj){
				var fieldsForDates = [
					'_ValidFrom',
					'_ValidTo',
					'AcceptedDate',
					'c_DevBeginDate',
					'c_DevEndDate',
					'ClosedDate',
					'CreationDate',
					'InProgressDate',
					'LastUpdateDate',
					'OpenedDate'
				];
				for(var i=0;i<dataObj.length;i++){
					// Sort dates
					for(var f=0;f<fieldsForDates.length;f++){
						if(fieldsForDates[f] in dataObj[i]){
							dataObj[i][fieldsForDates[f]] = utilityFn.dates.toSortable(new Date(dataObj[i][fieldsForDates[f]]) );
						}
					}
					// Hydrate objects to ref name
					for(var key in dataObj[i]){
						if( typeof(dataObj[i][key]) == 'object' ){
							dataObj[i][key] = ( (dataObj[i][key] !== null)&&(dataObj[i][key].hasOwnProperty('_refObjectName')) ) ? dataObj[i][key]._refObjectName : '';
						}
					}
				}
				return dataObj;
			};
			// Prep data store object based on Selected Custom COlumns
			function prepStoreObj(manualCols){
				var selectedCols = Ext.getCmp('ColumnPicker').getValue();
				var result = {
					headers : [],
					fields : [],
					values : []
				};
				for(var i=0;i<selectedCols.length;i++){
					result.headers.push({ text : selectedCols[i].data.displayName, dataIndex : selectedCols[i].data.name});
					result.fields.push(selectedCols[i].data.name);
				}
				for(var i=0;i<manualCols.length;i++){
					//if( manualCols[i].hasOwnProperty('editor') ){
					//	result.headers.push(manualCols[i]);
					//}
					result.headers.push({ text : manualCols[i].text, dataIndex : manualCols[i].dataIndex});
					result.fields.push(manualCols[i].dataIndex);
				}
				return result;
			}
			// Create results grid
			function createGridFromStore(dataStore,options){
				var gridPanelSet = [];
				var gridData = Ext.create('Ext.data.Store',{
					storeId : (options.hasOwnProperty('id')) ? options.id : 'GenericStoreId',
					fields : dataStore.fields,
					data : { 'items' : dataStore.values },
					proxy : {
						type : 'memory',
						reader : {
							type : 'json',
							root : 'items'
						}
					}
				});
				var columnSettings = (options.hasOwnProperty('settings')) ? options.settings : {};
				columnSettings.flex = 1;

				var gridPanel = Ext.create('Ext.grid.Panel',{
					title : (options.hasOwnProperty('headline')) ? options.headline : null,
					store : (options.hasOwnProperty('id')) ? options.id : 'GenericStoreId',
					columns : {
						items : dataStore.headers,
						defaults : columnSettings
					}
				});
				gridPanelSet.push(gridPanel);
				if(options.hasOwnProperty('exportToCSV')&&(options.exportToCSV == true)){
					var buttonbar = csv.getExtJsBtnBar(gridData);
					gridPanelSet.push(buttonbar);
				}
				return gridPanelSet;
			}
			// Render report options
			function toggleReportOptions(field,newValue,oldValue){
				var rallyApp = Rally.getApp('CustomApp');
				var reportType = newValue['request-type'];

				var optionsObj = rallyApp.reportDetails[reportType]();
				renderContent(optionsObj,'report-input-container');
				renderContent(false,'report-output-container'); // set to clear out the output div on toggle
			}
			// Initiate data collection and validation before performing the core fetch and rendering functions
			function prepareReportQuery(reportType){
				// Render Progress Modal
				messageFn.progressBox(labels.messages.gettingUserStories);

				// Collect report data based on 'reportType', in specific structure (opportunity for selected cols, query, etc)
				var dataObj = collectData[reportType]();

				// Collect any error messages for the report options
				var errorsList = validateData[reportType](dataObj);
				if(errorsList.length > 0){
					var errorMessageList = utilityFn.errorsListHtml(errorsList.unique());
					messageFn.alertBox(errorMessageList);
					return false;
				}else{
					runReportQuery[reportType](dataObj);
				}
			}
			// Report-specific page data collection
			var collectData = {
				AcceptedDefectsReport : function(){
					var result = {
						columns : Ext.getCmp('ColumnPicker').getValue(),
						dates : {
							closing : utilityFn.dates.toEvening(Ext.getCmp('ClosingDatePicker').getValue()),
							opening : utilityFn.dates.toMorning(Ext.getCmp('OpeningDatePicker').getValue())
						},
						environment : Ext.getCmp('RallyField_Environment').getValue(),
						priority : Ext.getCmp('RallyField_Priority').getValue(),
					};
					return result;
				},
				BurndownData : function(){
					var result = {
						dates : {
							closing : utilityFn.dates.toEvening(Ext.getCmp('ClosingDatePicker').getValue()),
							opening : utilityFn.dates.toMorning(Ext.getCmp('OpeningDatePicker').getValue()),
							weekends : (Ext.getCmp('WeekendPicker')) ? Ext.getCmp('WeekendPicker').getValue() : false
						},
						query : Ext.getCmp('GeneratedQueryField').getValue().trim(),
						type : Ext.getCmp('BurndownQueryType').getValue()['query-type']
					};
					return result;
				},
				StoryStateChanges : function(){
					var result = {
						columns : Ext.getCmp('ColumnPicker').getValue(),
						dates : {
							closing : utilityFn.dates.toEvening(Ext.getCmp('ClosingDatePicker').getValue()),
							opening : utilityFn.dates.toMorning(Ext.getCmp('OpeningDatePicker').getValue())
						},
						states : {
							closing : Ext.getCmp('RallyField_StateTo').getValue(),
							opening : Ext.getCmp('RallyField_StateFrom').getValue()
						},
						query : Ext.getCmp('GeneratedQueryField').getValue().trim()
					};
					return result;
				},
				StoryStateSnapshot : function(){
					var result = {
						columns : Ext.getCmp('ColumnPicker').getValue(),
						dates : {
							date : utilityFn.dates.toISO(Ext.getCmp('HiddenDateTimeObj').getValue())
						},
						query : Ext.getCmp('GeneratedQueryField').getValue().trim()
					};
					return result;
				},
				TaskCreation : function(){
					var textboxValue = Ext.getCmp('StoryIdList').getValue().trim().replace(/\n/g,',').replace(/ /g,'');
					var idArray = textboxValue.toUpperCase().split(',').unique().trimArray();
					var result = {
						ids : idArray,
						store : Ext.StoreMgr.lookup('TaskTemplateStore')
					};
					return result;
				}
			};
			// Report-specific page data validation
			var validateData = {
				_formattedIdChecks : function(ids){
					var errorsList = [];
					var validPrefixes = ['DE','US'];

					if(ids.length <= 0){ errorsList.push(labels.errors.idListEmpty); }
					for(var i=0;i<ids.length;i++){
						var item = ids[i];
						var prefix = item.substring(0,2);
						var thirtdChar = parseInt(item.substring(2,3));

						if(validPrefixes.indexOf(prefix) < 0){
							errorsList.push(item + labels.errors.storyIdInvalidTypeWithId);
						}
						if(isNaN(thirtdChar)){
							errorsList.push(item + labels.errors.storyIdInvalidIdWithId);
						}
					}
					return errorsList;
				},
				_queryChecks : function(queryString){
					var errorsList = [];
					var numParensOpen =  (queryString.indexOf('(') >= 0) ? queryString.match(/\(/gi).length : false;
					var numParensClosed =  (queryString.indexOf(')') >= 0) ? queryString.match(/\)/gi).length : false;
					var numQuotes = queryString.match(/\"/gi).length;

					if(queryString == ''){ errorsList.push(labels.errors.queryEmpty); }
					if(numParensOpen !== numParensClosed){ errorsList.push(labels.errors.queryParensMismatch); }
					if(numQuotes%2 !== 0){ errorsList.push(labels.errors.queryQuotesMismatch); }
					return errorsList;
				},
				AcceptedDefectsReport : function(dataObj){
					var errorsList = [];
					var opening = Date.parse(dataObj.dates.opening);
					var closing = Date.parse(dataObj.dates.closing);

					if(opening > closing){ errorsList.push(labels.errors.datesBackwards); }
					if(dataObj.columns.length <= 0){ errorsList.push(labels.errors.zeroCols); }
					return errorsList;
				},
				BurndownData : function(dataObj){
					var errorsList = [];
					var opening = Date.parse(dataObj.dates.opening);
					var closing = Date.parse(dataObj.dates.closing);

					if(opening > closing){ errorsList.push(labels.errors.datesBackwards); }
					var queryErrors = this._queryChecks(dataObj.query);
					return errorsList.concat(queryErrors);
				},
				StoryStateChanges : function(dataObj){
					var errorsList = [];
					var opening = Date.parse(dataObj.dates.opening);
					var closing = Date.parse(dataObj.dates.closing);

					if(opening > closing){ errorsList.push(labels.errors.datesBackwards); }
					if(dataObj.columns.length <= 0){ errorsList.push(labels.errors.zeroCols); }
					var queryErrors = this._queryChecks(dataObj.query);
					return errorsList.concat(queryErrors);
				},
				StoryStateSnapshot : function(dataObj){
					var errorsList = [];

					if(dataObj.columns.length <= 0){ errorsList.push(labels.errors.zeroCols); }
					var queryErrors = this._queryChecks(dataObj.query);
					return errorsList.concat(queryErrors);
				},
				TaskCreation : function(dataObj){
					var errorsList = [];

					var idListErrors = this._formattedIdChecks(dataObj.ids)
					return errorsList.concat(idListErrors);
				}
			};
			// Core report-specific functionality once input data has been collected and validated
			var runReportQuery = {
				AcceptedDefectsReport : function(dataObj){
					var manualQueryParams = [
						{
							key : 'AcceptedDate',
							operand : '>=',
							value : utilityFn.dates.toISO(dataObj.dates.opening),
							operator : 'AND'
						},
						{
							key : 'AcceptedDate',
							operand : '<=',
							value : utilityFn.dates.toISO(dataObj.dates.closing),
							operator : 'AND'
						},
						{
							key : 'Environment',
							operand : '=',
							value : dataObj.environment,
							operator : 'AND'
						},
						{
							key : 'Priority',
							operand : '=',
							value : dataObj.priority,
							operator : 'AND'
						}
					];
					var formattedQuery = utilityFn.query.create(manualQueryParams);
					getDataFor.defects(formattedQuery,function(defectList){
						apiResultErrorCheck(defectList,function(){
							nextSteps(defectList);
						})
					});

					function nextSteps(defectList){
						if(defectList.length == 0){
							renderContent({ html : '<p>' + labels.errors.zeroResults + '</p>' },'report-output-container');
							messageFn.exit();
							return false;
						}
						var manualCols = [
							{ text : 'Days Active', dataIndex : 'DaysActive'},
							{ text : 'URL', dataIndex : 'Url'}
						];
						var dataStore = prepStoreObj(manualCols);
						var dataList = apiResultCleanup(defectList.QueryResult.Results);
						for(var d=0;d<dataList.length;d++){
							var lineItem = {};
							for(var k=0;k<dataStore.fields.length;k++){
								var key = dataStore.fields[k];
								var val = dataList[d][key];
								lineItem[key] = val;
							}
							// Manual column values
							lineItem['DaysActive'] = utilityFn.dates.daysBetween([lineItem.CreationDate,lineItem.ClosedDate]);
							lineItem['Url'] = '<a href="/#/' + __PROJECT_OID__ + 'd/search?keywords=' +  lineItem.FormattedID + '" target="_blank">' +  lineItem.FormattedID + '</a>';

							// Push the object into the return array
							dataStore.values.push(lineItem);
						}

						var gridOptions = {
							headline : 'Accepted defects by date',
							id : 'AcceptedDefectsReport',
							settings : {
								sortable : true,
								hideable : true,
								selectable : true
							},
							exportToCSV : true
						};
						var gridSet = createGridFromStore(dataStore,gridOptions);
						renderContent(gridSet,'report-output-container');

						messageFn.exit();
					}
				},
				BurndownData : function(dataObj){
					dataObj.dates.ends = utilityFn.dates.getDateEnds([dataObj.dates.opening,dataObj.dates.closing],dataObj.dates.weekends);
					getDataFor[dataObj.type](dataObj.query,function(returnObj){
						apiResultErrorCheck(returnObj,function(){
							// Collect ObjectIDs from results set
							dataObj.objectIDs = [];
							var results = returnObj.QueryResult.Results;
							for(var i=0;i<results.length;i++){
								dataObj.objectIDs.push({ 'ObjectID' : results[i].ObjectID});
							}

							// Create lookback search settings
							var hoursVar = (dataObj.type === 'tasks') ? 'ToDo' : 'TaskRemainingTotal';
							//var fieldsVar = ['ObjectID','Name','FormattedID'];
							var lookbackObj = {
								fields : ['ObjectID','Name','FormattedID','TaskRemainingTotal','ToDo'],
								find : {
									'$or' : dataObj.objectIDs,
									[hoursVar] : { '$gt' : 0 }
								}
							};

							// Set up couter to capture all daily entries
							var counterStep = 0;
							var counterStop = dataObj.dates.ends.length;

							// Collect Daily Burndown data, grouped by sortable date
							var resultsArray = [];
							for(var d=0;d<dataObj.dates.ends.length;d++){
								lookbackObj.find['__At'] = utilityFn.dates.toISO(dataObj.dates.ends[d]);
								lookback.snapshot(lookbackObj,function(result){
									console.log(result);
									//var displayDate = utilityFn.dates.toSortable(dataObj.dates.ends[d]);
									var displayDate = dataObj.dates.ends[d];
									var hoursRemaining = 0;
									for(var k=0;k<result.Results.length;k++){
										var storyHoursRemaining = result.Results[k][hoursVar];
										console.log(storyHoursRemaining);
										hoursRemaining+storyHoursRemaining;
									}
									resultsArray.push({ date : displayDate, hours : hoursRemaining });
									counterStep++;
									if(counterStep >= counterStop){ collectDayData(resultsArray); }
								});
							}

							// Execute once lookback is complete for all days
							function collectDayData(testData){
								messageFn.exit();
								console.log(testData);
							}
							
						})
					});
				},
				StoryStateChanges : function(dataObj){
					console.log(dataObj);
					messageFn.exit();
				},
				StoryStateSnapshot : function(dataObj){
					console.log(dataObj);
					messageFn.exit();
				},
				TaskCreation : function(dataObj){
					console.log(dataObj);
					messageFn.exit();
				}
			};

				/*
				switch(reportType){
					case 'BurndownData' :
						getDataFor.storiesAndDefects(searchQuery,function(returnObj){
							if(returnObj.QueryResult.Errors.length > 0){
								var errorMessageList = utilityFn.errorsListHtml( returnObj.QueryResult.Errors.unique() );
								messageFn.alertBox(errorMessageList);
							}else{
								lookback.taskHours(returnObj.QueryResult.Results,dates);
							}
						});
						break;
					case 'StoryStateChanges' :
						// var closingDate = queryFormattedDateEnd;
						// var closingQuery = ' AND (CreationDate <= "' + closingDate + '"))';
						// var updatedSearchQuery = '(' + searchQuery + ' AND ' + closingQuery;
						// getDataFor.storiesAndDefects(updatedSearchQuery,function(returnObj){
						getDataFor.storiesAndDefects(searchQuery,function(returnObj){
							if(returnObj.QueryResult.Errors.length > 0){
								var errorMessageList = utilityFn.errorsListHtml( returnObj.QueryResult.Errors.unique() );
								messageFn.alertBox(errorMessageList);
							}else{
								lookback.storyChanges(returnObj.QueryResult.Results);
							}
						});
						break;
					case 'StoryStateSnapshot' :
						var asOfDate = utilityFn.dates.toISO(Ext.getCmp('HiddenDateTimeObj').getValue());
						var queryPrepend = '(';
						var queryAppend = ' AND (CreationDate <= "' + asOfDate + '"))';
						getDataFor.storiesAndDefects(searchQuery,function(returnObj){
							if(returnObj.QueryResult.Errors.length > 0){
								var errorMessageList = utilityFn.errorsListHtml( returnObj.QueryResult.Errors.unique() );
								messageFn.alertBox(errorMessageList);
							}else{
								lookback.stateSnapshot(returnObj.QueryResult.Results);
							}
						});
						break;
					case 'TaskCreation' :
						var textboxValue = Ext.getCmp('StoryIdList').getValue().trim().replace(/\n/g,',').replace(/ /g,'');
						if(textboxValue.length == 0){
							messageFn.alertBox(labels.errors.idListEmpty);
						}else{
							var itemList = textboxValue.toUpperCase().split(',').unique().trimArray();
							// check that each array item starts with the proper prefix
							var formatCheck = utilityFn.validateElementData.formattedIDCheck(itemList);
							if(formatCheck.result == true){
								var queryifiedItems = [];
								for(var i=0;i<itemList.length;i++){
									if(i == 0){
										var openingParens = '';
										for(var p=0;p<itemList.length-1;p++){ openingParens += '('; }
										queryifiedItems.push(openingParens + '(FormattedID = "' + itemList[i] + '")');
									}else{
										queryifiedItems.push('(FormattedID = "' + itemList[i] + '"))');
									}
								}
								getDataFor.storiesAndDefects(queryifiedItems.join(' OR '),function(pageResult){
									var results = pageResult.QueryResult.Results;
									var assignmentArray = [];

									var startNum = 0;
									var endNum = results.length-1;

									function userLoop(n){
										var FormattedID = results[n].FormattedID;
										var DisplayName = results[n].c_DevResponsible;
										var userQuery = '(DisplayName = "' + DisplayName + '")';

										if(DisplayName){
											getDataFor.users(userQuery,function(userObj){
												assignmentArray.push({ id : FormattedID, dev : userObj.QueryResult.Results[0].EmailAddress });
												if(n < endNum){
													n++;
													userLoop(n);
												}else{
													updateDataStore(assignmentArray);
												}
											});
										}else{
											assignmentArray.push({ id : FormattedID, dev : '' });
											if(n < endNum){
												n++;
												userLoop(n);
											}else{
												updateDataStore(assignmentArray);
											}
										}
									}
									userLoop(startNum);
									function updateDataStore(assignmentArray){
										// Check for IE, determining which CSV format is output
										var ieBool = (window.navigator.msSaveOrOpenBlob && window.Blob) ? true : false;
										var lineSep = (ieBool) ? '\n' : '%0A'; // end lines

										// Load Data Store and see if I can add values to it -- will need to check that changes to the fields reflect
										var taskStore = Ext.StoreMgr.lookup('TaskTemplateStore');

										// Set up CSV headers
										var headerCSV = csv.getDataHeader(taskStore,ieBool);

										var linesCSV = '';
										for(var i=0;i<assignmentArray.length;i++){
											var id = assignmentArray[i].id;
											var email = assignmentArray[i].dev;

											var taskClone = taskStore;
											for(var t=0;t<taskClone.data.items.length;t++){
												taskClone.data.items[t].data.WorkProduct = id;
												taskClone.data.items[t].data.Owner = email;
											}
											var lineCSV = csv.getDataItems(taskClone,ieBool);
											linesCSV += (i == assignmentArray.length-1) ? lineCSV : lineCSV + lineSep;
										}
										var finalObjCSV = csv.getFinalString(headerCSV,linesCSV,ieBool);
										var hiddenDownload = {
											xtype : 'button',
											id : 'HiddenDownloadCSV',
											text : 'Download CSV',
											href : '#',
											listeners : {
												afterrender : function(element){
													if ( !(window.navigator.msSaveOrOpenBlob && window.Blob) ) {
														element.getEl().set({
															href : finalObjCSV
														});
													}
													element.getEl().set({
														download : 'export-data.csv',
														target : '_self'
													});
												},
												click : function(){
													if ( window.navigator.msSaveOrOpenBlob && window.Blob ) {
														var blob = new Blob([ finalObjCSV ],{ type: "text/csv" });
														navigator.msSaveOrOpenBlob(blob,'export-data.csv');
													}
												}
											}
										};
										renderContent(hiddenDownload,'report-output-container');
										messageFn.exit();
									}
								});
							}else{
								messageFn.alertBox(formatCheck.message);
								return false;
							}
						}
						break;
					default :
						messageFn.exit();
						return false;
				}
			}*/

			/* Get item IDs for a given query */
			var getDataFor = {
				_ajax : function(inputQuery,callback,options){
					var results = [];
					ajaxLoop(1);

					// set up loop for pages of API return (max 200 per request)
					function ajaxLoop(n){
						var baseUrl = '/slm/webservice/v2.0/' + options.apiCall;
						var urlObj = {
							workspace : '/slm/webservice/v2.0/workspace/' + __WORKSPACE_OID__,
							query : encodeURIComponent(inputQuery),
							// WHERE ACCEPTED DATE == NULL or later than Start date
							order : '',
							fetch : true,
							start : n,
							pagesize : 200,
							type : options.type
						};
						var encodedParams = utilityFn.encodeParams(urlObj);
						Ext.Ajax.request({
							method : 'GET',
							url : baseUrl + encodedParams,
							success : function(response){
								var pageResult = JSON.parse(response.responseText);
								var totalCount = pageResult.QueryResult.TotalResultCount;
								var itemsReturned = pageResult.QueryResult.Results.length;
								var nextStartNum = n + itemsReturned;
								results = results.concat(pageResult.QueryResult.Results);

								if(nextStartNum > totalCount){
									if( typeof(callback) == 'function'){
										pageResult.QueryResult = {
											Errors : pageResult.QueryResult.Errors,
											Results : results,
											TotalResultCount : pageResult.QueryResult.TotalResultCount
										};
										callback(pageResult);
									}else{
										return false;
									}
								}else{
									ajaxLoop(nextStartNum);
								}
							},
							failure : function(response){
								messageFn.alertBox(response.responseText);
							}
						});
					}
				},
				artifacts : function(inputQuery,callback){
					var options = {
						apiCall : 'artifact',
						type : 'defect,hierarchicalrequirement'
					};
					this._ajax(inputQuery,callback,options);
				},
				defects : function(inputQuery,callback){
					var options = {
						apiCall : 'defect',
						type : 'defect'
					};
					this._ajax(inputQuery,callback,options);
				},
				stories : function(inputQuery,callback){
					var options = {
						apiCall : 'hierarchicalrequirement',
						type : 'hierarchicalrequirement'
					};
					this._ajax(inputQuery,callback,options);
				},
				storiesAndDefects : function(inputQuery,callback){
					var allItems = { QueryResult : {} };
					var storyOptions = {
						apiCall : 'hierarchicalrequirement',
						type : 'hierarchicalrequirement'
					};
					this._ajax(inputQuery,function(storyList){
						var defectOptions = {
							apiCall : 'defect',
							type : 'defect'
						};
						var storyResults = storyList.QueryResult.Results;
						getDataFor._ajax(inputQuery,function(defectList){
							var defectResults = defectList.QueryResult.Results;
							if( typeof(callback) == 'function'){
								var totalItems = (storyResults.length) + (defectResults.length);
								allItems.QueryResult = {
									Errors : defectList.QueryResult.Errors,
									Results : storyResults.concat(defectResults),
									TotalResultCount : totalItems
								};
								callback(allItems);
							}else{
								return false;
							}
						},defectOptions);
					},storyOptions);
				},
				tasks : function(inputQuery,callback){
					var options = {
						apiCall : 'task',
						type : 'task'
				};
					this._ajax(inputQuery,callback,options);
				},
				users : function(inputQuery,callback){
					var options = {
						apiCall : 'user',
						type : 'user'
					};
					this._ajax(inputQuery,callback,options);
				}
			};

			/* Use the Lookback API to collect data objects. */
			var lookback = {
				_fieldsForHydration : [
					'Owner',
					'Parent',
					'Priority',
					'Project',
					'Release',
					'Resolution',
					'ScheduleState'
				],
			/*	storyChanges : function(storyList){
					// loading message
					messageFn.progressBox(labels.messages.gettingStoryDetails);

					// collect an array of object ids
					var objectIdArray = [];
					for(var i=0;i<storyList.length;i++){
						objectIdArray.push(storyList[i].ObjectID);
					}

					// define window of time
					var startingDate = utilityFn.dates.toMorning( Ext.getCmp('OpeningDatePicker').getValue() );
					var endingDate = utilityFn.dates.toEvening( Ext.getCmp('ClosingDatePicker').getValue() );

					// collect the states being asked to report on
					var openingState = Ext.getCmp('RallyField_StateFrom').getValue();
					var closingState = Ext.getCmp('RallyField_StateTo').getValue();
					var manualCols = Ext.getCmp('ColumnPicker').getValue();
					var requiredFields = [
						{
							text : 'Date',
							dataIndex : '_ValidFrom'
						},
						{
							text : 'ID',
							dataIndex : 'FormattedID'
						},
						{
							text : 'Name',
							dataIndex : 'Name'
						},
						{
							text : 'Changed From',
							dataIndex : '_PreviousValues.c_KanbanState'
						},
						{
							text : 'Changed To',
							dataIndex : 'c_KanbanState'
						},
						{
							text : 'Release',
							dataIndex : 'Release'
						}
					];
					var includedFields = requiredFields;

					for(var m=0;m<manualCols.length;m++){
						var exists = false;
						var manualEntry = {
							text : manualCols[m].data.displayName,
							dataIndex : manualCols[m].data.name
						}
						for(var i=0;i<includedFields.length;i++){
							if(manualEntry.dataIndex === includedFields[i].dataIndex){
								exists = true;
							}
						}
						if(exists == false){
							includedFields.push(manualEntry);
						}
					}
					var includedFieldsForRallyQuery = [];
					var includedFieldsForRallyHydrate = [];

					for(var k=0;k<includedFields.length;k++){
						var field = includedFields[k].dataIndex;
						includedFieldsForRallyQuery.push(field);
						if( this._fieldsForHydration.indexOf(field) >= 0 ){
							includedFieldsForRallyHydrate.push(field);
						}
					}

					var result = [];
					ajaxLoop(1);

					// set up loop for pages of API return (max 200 per request)
					function ajaxLoop(n){
						// collecting status information for each object in the list
						Ext.Ajax.request({
							url : '/analytics/v2.0/service/rally/workspace/' + __WORKSPACE_OID__ + '/artifact/snapshot/query.js',
							jsonData : {
								'find' : {
									'ObjectID' : { '$in' : objectIdArray },
									'_PreviousValues.c_KanbanState' : {
										'$gte' : openingState,
										'$lt'  : closingState
									},
									'c_KanbanState' : { '$lte' : closingState },
									'_ValidFrom' : {
										'$gte' : startingDate,
										'$lte' : endingDate
									}
								},
								'start' : n,
								'fields' : includedFieldsForRallyQuery//,
								//'hydrate' : includedFieldsForRallyHydrate
							},
							method : 'POST',
							headers : {
								'Content-Type' : 'application/json'
							},
							success : function(response){
								var pageResult = JSON.parse(response.responseText);
								var totalCount = pageResult.TotalResultCount;
								var itemsReturned = pageResult.Results.length;
								var nextStartNum = n + itemsReturned;
								result = result.concat(pageResult.Results);

								if(nextStartNum >= totalCount){
									var dataStory = collectStateChangesData(result,includedFields,includedFieldsForRallyQuery);
									if(dataStory.length > 0){
										renderContent(dataStory,'report-output-container');
									}else{
										renderContent({ html : '<p>' + labels.errors.zeroResults + '</p>' },'report-output-container');
									}
									messageFn.exit();
								}else{
									ajaxLoop(nextStartNum);
								}
							},
							failure : function(response){
								messageFn.alertBox(JSON.parse(response.responseText).Errors);
							}
						});
					}
				},
				stateSnapshot : function(storyList){
					// loading message
					messageFn.progressBox(labels.messages.gettingStoryDetails);

					// collect an array of object ids
					var objectIdArray = [];
					for(var i=0;i<storyList.length;i++){
						objectIdArray.push(storyList[i].ObjectID);
					}

					// collect the time stamp to report on
					var snapshotTime = utilityFn.dates.toISO(Ext.getCmp('HiddenDateTimeObj').getValue());

					var manualCols = Ext.getCmp('ColumnPicker').getValue();
					var requiredFields = [
						{
							text : 'ObjectID',
							dataIndex : 'ObjectID'
						},
						{
							text : 'ID',
							dataIndex : 'FormattedID'
						},
						{
							text : 'Name',
							dataIndex : 'Name'
						},
						{
							text : 'Kanban State',
							dataIndex : 'c_KanbanState'
						},
						{
							text : 'Schedue State',
							dataIndex : 'ScheduleState'
						}
					//	},
					//	{
					//		text : 'Release',
					//		dataIndex : 'Release'
					//	}
					];
					var includedFields = requiredFields;

					for(var m=0;m<manualCols.length;m++){
						var exists = false;
						var manualEntry = {
							text : manualCols[m].data.displayName,
							dataIndex : manualCols[m].data.name
						}
						for(var i=0;i<includedFields.length;i++){
							if(manualEntry.dataIndex === includedFields[i].dataIndex){
								exists = true;
							}
						}
						if(exists == false){
							includedFields.push(manualEntry);
						}
					}
					var includedFieldsForRallyQuery = [];
					var includedFieldsForRallyHydrate = [];

					for(var k=0;k<includedFields.length;k++){
						var field = includedFields[k].dataIndex;
						includedFieldsForRallyQuery.push(field);
						if( this._fieldsForHydration.indexOf(field) >= 0 ){
							includedFieldsForRallyHydrate.push(field);
						}
					}

					var result = [];
					ajaxLoop(1);

					// set up loop for pages of API return (max 200 per request)
					function ajaxLoop(n){
						// collecting status information for each object in the list
						Ext.Ajax.request({
							url : '/analytics/v2.0/service/rally/workspace/' + __WORKSPACE_OID__ + '/artifact/snapshot/query.js',
							jsonData : {
								'find' : {
									'ObjectID' : { '$in' : objectIdArray },
									'__At' : snapshotTime
								},
								'start' : n,
								'fields' : includedFieldsForRallyQuery//,
								//'hydrate' : includedFieldsForRallyHydrate
							},
							method : 'POST',
							headers : {
								'Content-Type' : 'application/json'
							},
							success : function(response){
								var pageResult = JSON.parse(response.responseText);
								var totalCount = pageResult.TotalResultCount;
								var itemsReturned = pageResult.Results.length;
								var nextStartNum = n + itemsReturned;
								result = result.concat(pageResult.Results);

								if(nextStartNum >= totalCount){
								//	var dataStory = collectStateChangesData(result,includedFields,includedFieldsForRallyQuery);
									if(result.length > 0){
										var dataStory = collectStorySnapshot(result,includedFields,includedFieldsForRallyQuery);
										renderContent(dataStory,'report-output-container');
									}else{
										renderContent({ html : '<p>' + labels.errors.zeroResults + '</p>' },'report-output-container');
									}
									messageFn.exit();
								}else{
									ajaxLoop(nextStartNum);
								}
							},
							failure : function(response){
								messageFn.alertBox(JSON.parse(response.responseText).Errors);
							}
						});
					}
				},
			*/	snapshot : function(lookbackObj,callback){
					//console.log(lookbackObj);
					Ext.Ajax.request({
						url : '/analytics/v2.0/service/rally/workspace/' + __WORKSPACE_OID__ + '/artifact/snapshot/query.js',
						jsonData : {
							'find' : lookbackObj.find,
							'fields' : lookbackObj.fields
						},
						method : 'POST',
						headers : {
							'Content-Type' : 'application/json'
						},
						success : function(response){
							callback(JSON.parse(response.responseText));
						},
						failure : function(response){
							messageFn.alertBox(JSON.parse(response.responseText).Errors);
							return false;
						}
					});
				},
				taskHours :  function(storyList,dates){
					// loading message
					messageFn.progressBox(labels.messages.gettingStoryDetails);

					// collect an array of object ids
					var objectIdArray = [];
					for(var i=0;i<storyList.length;i++){
						objectIdArray.push({ 'ObjectID' : storyList[i].ObjectID });
					}

					// date object for getting STATES at the end of each day in a given range
					var dateEndArray = dates.end;

					// AJAX iteration counter and execution function
					var requestCount = dateEndArray.length;
					var requestComplete = 0,
					onAjaxCompleteCheck = function(){
						requestComplete++;
						if(requestComplete >= requestCount){
							var output = collectBurndownInfo(result);
							renderContent(output,'report-output-container');
							messageFn.exit();
						}
					};

					// collecting task hours for each object in the array at each date interval
					var result = [];
					for(var j=0;j<dateEndArray.length;j++){
						var date = dateEndArray[j];
						var isoDate = date.toISOString();
						var includeWeekends = (Ext.getCmp('WeekendPicker')) ? Ext.getCmp('WeekendPicker').getValue() : false;

						if( includeWeekends == true ){
							var skipDay = false;
						}else{
							var dayOfWeek = date.getDay();
							var skipDay = ( (dayOfWeek == 0)||(dayOfWeek == 6) ) ? true : false;
						}

						if(!skipDay){
							Ext.Ajax.request({
								url : '/analytics/v2.0/service/rally/workspace/' + __WORKSPACE_OID__ + '/artifact/snapshot/query.js',
								jsonData : {
									'find' : {
										'$or' : objectIdArray,
										'__At' : isoDate
									},
									'fields' : ['ObjectID','Name','FormattedID','TaskRemainingTotal']
								},
								method : 'POST',
								headers : {
									'Content-Type' : 'application/json'
								},
								success : function(response){
									result.push(JSON.parse(response.responseText));
									onAjaxCompleteCheck();
								},
								failure : function(response){
									messageFn.alertBox(JSON.parse(response.responseText).Errors);
								}
							});
						}else{
							onAjaxCompleteCheck();
						}
					}
				}
			};

			/* Create date store for task data */
			var createStoreData = {
				_convertHydratedData : function(dataObj){
					for(var key in dataObj){
						if( typeof(dataObj[key]) == 'object' ){
							var val = ( (dataObj[key] !== null)&&(dataObj[key].hasOwnProperty('_refObjectName')) ) ? dataObj[key]._refObjectName : '';
							dataObj[key] = val;
						}
					}
					return dataObj;
				},
				_convertSortableDates : function(dataObj){
					var fieldsForDates = [
						'_ValidFrom',
						'_ValidTo',
						'AcceptedDate',
						'c_DevEndDate',
						'ClosedDate',
						'CreationDate',
						'InProgressDate',
						'LastUpdateDate',
						'OpenedDate'
					];
					for(var f=0;f<fieldsForDates.length;f++){
						if(fieldsForDates[f] in dataObj){
							var dateObj = new Date(dataObj[fieldsForDates[f]]);
							dataObj[fieldsForDates[f]] = utilityFn.dates.toSortable(dateObj);
						}
					}
					return dataObj;
				},
				_getDataFromSelectedCols : function(id){
					var selectedCols = (Ext.getCmp(id)) ? Ext.getCmp(id).getValue() : [];
					var result = {
						headers : [],
						fields : [],
						values : []
					};
					for(var i=0;i<selectedCols.length;i++){
						result.headers.push({ text : selectedCols[i].data.displayName, dataIndex : selectedCols[i].data.name});
						result.fields.push(selectedCols[i].data.name);
					}
					return result;
				},
				acceptedDefects : function(dataObj){
					// Set up main return array
					var result = this._getDataFromSelectedCols('ColumnPicker');

					// Manual columns/headers
					result.headers.push(
						{ text : 'Days Active', dataIndex : 'DaysActive'},
						{ text : 'URL', dataIndex : 'Url'}
					);

					// Manual fields (headers indicies)
					result.fields.push('DaysActive','Url');

					for(var j=0;j<dataObj.length;j++){
						var sortableObj = this._convertSortableDates(dataObj[j]);
						var userFriendlyObj = this._convertHydratedData(sortableObj);

						// Obj creation from selected columns
						var lineItem = {};
						for(var k=0;k<result.fields.length;k++){
							var key = result.fields[k];
							var val = userFriendlyObj[key];
							lineItem[key] = val;
						}

						// Manual columns and values
						lineItem['DaysActive'] = utilityFn.dates.daysBetween([lineItem.CreationDate,lineItem.ClosedDate]);
						lineItem['Url'] = '<a href="/#/' + __PROJECT_OID__ + 'd/search?keywords=' +  lineItem.FormattedID + '" target="_blank">' +  lineItem.FormattedID + '</a>';

						// Push the object into the return array
						result.values.push(lineItem);
					}
					return result;
				},
				stateChanges : function(dataObj){
					var result = [];
					var stateCmpExample = Ext.getCmp('RallyField_StateTo');

					for(var i=0;i<dataObj.length;i++){
						var endState = dataObj[i].c_KanbanState;
						var endStateRecord = stateCmpExample.findRecordByValue(endState);
						var endStateIndex = stateCmpExample.getStore().indexOf(endStateRecord);

						var prevState = dataObj[i]._PreviousValues.c_KanbanState;
						var prevStateRecord = stateCmpExample.findRecordByValue(prevState);
						var prevStateIndex = stateCmpExample.getStore().indexOf(prevStateRecord);

						if(prevStateIndex < endStateIndex){
							if( !(result.hasOwnProperty(endStateIndex)) ){
								result[endStateIndex] = {
									state : endState,
									stories : []
								};
							}
							dataObj[i] = this._convertSortableDates(dataObj[i]);
							dataObj[i].Release = (dataObj[i].hasOwnProperty('Release')) ? dataObj[i].Release.Name : 'Unassigned';
							result[endStateIndex].stories.push(dataObj[i]);
						}
					}
					return result;
				},
				stateSnapshot : function(dataObj){
					// Set up main return array
					var result = this._getDataFromSelectedCols('ColumnPicker');

					// Manual columns/headers
					result.headers.push(
						{ text : 'URL', dataIndex : 'Url'}
					);

					// Manual fields (headers indicies)
					result.fields.push('Url');

					for(var j=0;j<dataObj.length;j++){
						var sortableObj = this._convertSortableDates(dataObj[j]);
						var userFriendlyObj = this._convertHydratedData(sortableObj);

						// Obj creation from selected columns
						var lineItem = {};
						for(var k=0;k<result.fields.length;k++){
							var key = result.fields[k];
							var val = userFriendlyObj[key];
							lineItem[key] = val;
						}

						// Manual columns and values
						lineItem['Url'] = '<a href="/#/' + __PROJECT_OID__ + 'd/search?keywords=' +  lineItem.FormattedID + '" target="_blank">' +  lineItem.FormattedID + '</a>';

						// Push the object into the return array
						result.values.push(lineItem);
					}
					return result;
				},
				taskDefaults : function(){
					var result = this._getDataFromSelectedCols('ColumnPicker');
					/*
						_getDataFromSelectedCols : function(id){
							var selectedCols = (Ext.getCmp(id)) ? Ext.getCmp(id).getValue() : [];
							var result = {
								headers : [],
								fields : [],
								values : []
							};
							for(var i=0;i<selectedCols.length;i++){
								result.headers.push({ text : selectedCols[i].data.displayName, dataIndex : selectedCols[i].data.name});
								result.fields.push(selectedCols[i].data.name);
							}
							return result;
						},
					*/
					var templateItems = [
						{ text : 'Display Color', dataIndex : 'DisplayColor'},
						{ text : 'Expedite', dataIndex : 'Expedite' },
						{ text : 'Ready', dataIndex : 'Ready' },
						{ text : 'Actuals', dataIndex : 'Actuals' },
						{ text : 'Blocked', dataIndex : 'Blocked' },
						{ text : 'Blocked Reason', dataIndex : 'BlockedReason' },
						{ text : 'Estimate', dataIndex : 'Estimate', editor : { xtype : 'numberfield', minValue : '0' } },
						{ text : 'State', dataIndex : 'State' },
						{ text : 'To Do', dataIndex : 'ToDo', editor : { xtype : 'numberfield', minValue : '0' } },
						{ text : 'Formatted ID', dataIndex : 'WorkProduct' },
						{ text : 'Name', dataIndex : 'Name', editor : 'textfield' },
						{ text : 'Description', dataIndex : 'Description', editor : 'textfield' },
						{ text : 'Notes', dataIndex : 'Notes', editor : 'textfield' },
						{ text : 'Backlog State', dataIndex : 'BacklogState' },
						{ text : 'Owner', dataIndex : 'Owner' }
					];
					for(var i=0;i<templateItems.length;i++){
						if( templateItems[i].hasOwnProperty('editor') ){
							result.headers.push(templateItems[i]);
						}
						result.fields.push(templateItems[i].dataIndex);
					}
					var dataArray = [
						{ Name : 'Defect reproduction', Description : 'Time spent reproducing complex defect stories' },
						{ Name : 'High-level design/solution approach', Description : '' },
						{ Name : 'DB design', Description : 'Database design and development' },
						{ Name : 'Stored Procedure', Description : 'SPROC design and development' },
						{ Name : 'Create/modify web services	', Description : '' },
						{ Name : 'Create/modify web pages	HTML, CSS, JS', Description : '' },
						{ Name : 'Create/modify View Settings module', Description : '' },
						{ Name : 'Check-in Demo', Description : 'Demo of feature before Code Complete for the story' },
						{ Name : 'Internal code review', Description : '' },
						{ Name : 'Deployment readiness', Description : 'Documentation, risks, deployment requirements, etc.' },
						{ Name : 'Dev to QA/PM Hand-off	', Description : '' }
					];
					for(var i=0;i<dataArray.length;i++){
						result.values.push({
							DisplayColor : '',
							Expedite : false,
							Ready : true,
							Actuals : 0,
							Blocked : false,
							BlockedReason : '',
							Estimate : 0,
							State : 'Defined',
							ToDo : 0,
							WorkProduct : '',
							Name : dataArray[i].Name,
							Description : dataArray[i].Description,
							Notes : '',
							BacklogState : '',
							Owner : ''
						});
					}
					return result;
				},
				taskHours : function(dataObj){
					var resultsArray = [];
					for(var i=0;i<dataObj.length;i++){
						/* Get all of the 'TaskRemainingTotal' numbers */
						var hoursRemaining = 0;
						var results = dataObj[i].Results;
						for(var j=0;j<results.length;j++){
							hoursRemaining = hoursRemaining + parseInt(results[j].TaskRemainingTotal);
						}
						var sortableObj = this._convertSortableDates(dataObj[i]);
						/* Get the End Date in ISO for each item in the array */
						sortableObj.date = utilityFn.dates.toSortable(new Date(dataObj[i].GeneratedQuery.find.$and[0]._ValidTo.$gt));
						sortableObj.hours = hoursRemaining;
						resultsArray.push(sortableObj);
					}
					return resultsArray;
				}
			};

			/* Render a list of hours remaining for each day in the range */
			function collectBurndownInfo(dataObj){
				messageFn.progressBox(labels.messages.renderingBurndownData);

				var formattedData = createStoreData.taskHours(dataObj);

				var gridData = Ext.create('Ext.data.Store',{
					storeId : 'burndownDataStore',
					fields : ['date','hours'],
					data : { 'items' : formattedData },
					sorters : [
						{
							property : 'date',
							direction : 'ASC'
						}
					],
					proxy : {
						type : 'memory',
						reader : {
							type : 'json',
							root : 'items'
						}
					}
				});
				var gridPanel = Ext.create('Ext.grid.Panel',{
					title : 'Raw Burndown Data',
					cls : 'colMid',
					store : 'burndownDataStore',
					columns : {
						items : [
							{
								text : 'Date',
								dataIndex : 'date'
							},
							{
								text : 'Task Hours Remaining',
								dataIndex : 'hours'
							}
						],
						defaults : {
							flex : 1,
							hideable : false
						}
					},
					viewConfig : {
						enableTextSelection : false
					},
					bbar : csv.getExtJsBtnBar(gridData)
				});
				var chart = new Ext.chart.Chart({
					cls : 'colMid',
					width : 800,
					height : 300,
					store : 'burndownDataStore',
					theme : 'Category4',
					axes : [
						{
							title : 'Task Hours Remaining',
							type : 'Numeric',
							position : 'left',
							fields : 'hours',
							minimum : 0
						},
						{
							title : 'Date',
							type : 'Time',
							position : 'bottom',
							grid : true,
							fields : 'date',
							dateFormat : 'm/d',
							constrain: true
						}
					],
					series: [
						{
							type : 'line',
							xField : 'date',
							yField : 'hours',
							label : {
								display : 'over',
								field : 'hours'
							},
							highlight : true
						}
					]
				});
				var output = {
					cls : 'colWrapper',
					items : [gridPanel,chart]
				};
				return output;
			}

			/* Render a list of hours remaining for each day in the range */
			function collectStateChangesData(dataObj,pairedFields,fieldDataIds){
				messageFn.progressBox(labels.messages.gettingStateChanges);
				var unformattedData = createStoreData.stateChanges(dataObj);
				var formattedData = unformattedData.filter(function(){return true;});
				var gridPanelSet = [];

				for(var i=0;i<formattedData.length;i++){
					var dataStories = formattedData[i].stories;
					var gridData = Ext.create('Ext.data.Store',{
						storeId : 'stateChangeDataStore_' + i,
						fields : fieldDataIds,
						data : { 'items' : dataStories },
						sorters : [
							{
								property : '_ValidFrom',
								direction : 'ASC'
							}
						],
						proxy : {
							type : 'memory',
							reader : {
								type : 'json',
								root : 'items'
							}
						}
					});
					//href : '<a href="/#/' + __PROJECT_OID__ + 'd/search?keywords=' +  dataObj[i].FormattedID + '" target="_blank">' +  dataObj[i].FormattedID + '</a>'
					var gridPanel = Ext.create('Ext.grid.Panel',{
						title : 'Changed to <strong>' + formattedData[i].state + '</strong> state',
						store : 'stateChangeDataStore_' + i,
						columns : {
							items : pairedFields,
							defaults : {
								flex : 1,
								sortable : true,
								hideable : true,
								selectable : true
							}
						},
						viewConfig : {
							enableTextSelection : false
						}
					});
					var buttonbar = csv.getExtJsBtnBar(gridData);
					gridPanelSet.push(gridPanel);
					gridPanelSet.push(buttonbar);
				}
				return gridPanelSet;
			}
			function collectAcceptedDefectsData(dataObj,pairedFields,fieldDataIds){
				messageFn.progressBox(labels.messages.gettingStateChanges);
				var formattedData = createStoreData.acceptedDefects(dataObj);
				var gridPanelSet = [];

				var gridData = Ext.create('Ext.data.Store',{
					storeId : 'acceptedDefectsDataStore',
					fields : formattedData.fields,
					data : { 'items' : formattedData.values },
					sorters : [
						{
							property : 'CreationDate',
							direction : 'ASC'
						}
					],
					proxy : {
						type : 'memory',
						reader : {
							type : 'json',
							root : 'items'
						}
					}
				});
				var gridPanel = Ext.create('Ext.grid.Panel',{
					title : 'Accepted defects by date',
					store : 'acceptedDefectsDataStore',
					columns : {
						items : formattedData.headers,
						defaults : {
							flex : 1,
							sortable : true,
							hideable : true,
							selectable : true
						}
					},
					viewConfig : {
						enableTextSelection : false
					}
				});
				var buttonbar = csv.getExtJsBtnBar(gridData);
				
				gridPanelSet.push(gridPanel);
				gridPanelSet.push(buttonbar);
				return gridPanelSet;
			}
			function collectStorySnapshot(dataObj,pairedFields,fieldDataIds){
				messageFn.progressBox(labels.messages.gettingStateChanges);
				var formattedData = createStoreData.stateSnapshot(dataObj);
				var gridPanelSet = [];

				var gridData = Ext.create('Ext.data.Store',{
					storeId : 'snapshotStateStore',
					fields : formattedData.fields,
					data : { 'items' : formattedData.values },
					sorters : [
						{
							property : 'CreationDate',
							direction : 'ASC'
						}
					],
					proxy : {
						type : 'memory',
						reader : {
							type : 'json',
							root : 'items'
						}
					}
				});
				var gridPanel = Ext.create('Ext.grid.Panel',{
					title : 'Story State Snapshot',
					store : 'snapshotStateStore',
					columns : {
						items : formattedData.headers,
						defaults : {
							flex : 1,
							sortable : true,
							hideable : true,
							selectable : true
						}
					},
					viewConfig : {
						enableTextSelection : false
					}
				});
				var buttonbar = csv.getExtJsBtnBar(gridData);
				
				gridPanelSet.push(gridPanel);
				gridPanelSet.push(buttonbar);
				return gridPanelSet;
			}

			/* BEGIN JS Object to CSV code */
			var csv = {
				getDataHeader : function(dataObj,dataIE){
					var items = dataObj.data.items;
					var colSep = (dataIE) ? ',' : '%2C'; // between lines

					var headers = []; // column headers, unecoded and not joined
					for(var key in items[0].data){
						// Add a spce before the second uppercase letter
						var keyString = key.substring(0,1) + key.substring(1).replace(/([a-z])?([A-Z])/g,'$1 $2');
						// create an array of header objects, then merge/implode and add final break
						headers.push('"' + encodeURI(keyString) + '"');
					}
					headers = headers.join(colSep);
					return headers;
				},
				getDataItems : function(dataObj,dataIE){
					var items = dataObj.data.items;
					var colSep = (dataIE) ? ',' : '%2C'; // between lines
					var lineSep = (dataIE) ? '\n' : '%0A'; // end lines

					var lineArray = []; // line items, unecoded and not joined
					var lineItems = []; // line items, ecoded and joined

					for(var i=0;i<items.length;i++){
						var lineItem = [];
						for(var key in items[i].data){
							// create an array of header objects, then merge and add final break
							lineItem.push('"' + encodeURI(items[i].data[key]) + '"');
						}
						lineArray[i] = lineItem.join(colSep);
					}
					lineItems = lineArray.join(lineSep);
					return lineItems;
				},
				getFinalString : function(headers,lineItems,dataIE){
					var lineSep = (dataIE) ? '\n' : '%0A'; // end lines
					var finalString = headers + lineSep + lineItems;

					if(dataIE){
						var parsedString = finalString.replace(/%E2%80%8E/g,'').replace(/%20/g,' ');
						return parsedString;
					}else{
						return 'data:text/csv;charset=utf-8,' + finalString;
					}
				},
				getDataString : function(dataObj,dataIE){
					var items = dataObj.data.items;
					/* scenario for no data needed */
					var colSep = (dataIE) ? ',' : '%2C';
					var lineSep = (dataIE) ? '\n' : '%0A';
					/* '%2C' between items / '%0A' to end lines */

					var headers = []; // column headers, unecoded and not joined
					var lineArray = []; // line items, unecoded and not joined
					var lineItems = []; // line items, ecoded and joined

					for(var key in items[0].data){
						// create an array of header objects, then merge/implode and add final break
						headers.push('"' + encodeURI(key) + '"');
					}
					headers = headers.join(colSep);
					for(var i=0;i<items.length;i++){
						var lineItem = [];
						for(var key in items[i].data){
							// create an array of header objects, then merge and add final break
							lineItem.push('"' + encodeURI(items[i].data[key]) + '"');
						}
						lineArray[i] = lineItem.join(colSep);
					}
					var lineItems = lineArray.join(lineSep);
					var finalString = headers + lineSep + lineItems;
					if(dataIE){
						var parsedString = finalString.replace(/%E2%80%8E/g,'').replace(/%20/g,' ');
						return parsedString;
					}else{
						return 'data:text/csv;charset=utf-8,' + finalString;
					}
				},
				getExtJsBtnBar : function(dataObj){
					var returnObj = Ext.create('Ext.toolbar.Toolbar',{
						items : [{
							xtype : 'button',
							text : 'Export to CSV',
							href : '#',
							listeners : {
								afterrender : function(element){
									if ( !(window.navigator.msSaveOrOpenBlob && window.Blob) ) {
										element.getEl().set({
											href : csv.getDataString(dataObj)
										});
									}
									element.getEl().set({
										download : 'export-data.csv',
										target : '_self'
									});
								},
								click : function(){
									if ( window.navigator.msSaveOrOpenBlob && window.Blob ) {
										var dataOnly =  csv.getDataString(dataObj,true);
										var blob = new Blob([ dataOnly ],{ type: "text/csv" });
										navigator.msSaveOrOpenBlob(blob,'export-data.csv');
									}
								}
							}
						}]
					});
					return returnObj;
				}
			};

			/* Control for rendering page content */
			function renderContent(objects,location){
				Ext.getCmp(location).removeAll();
				if(objects){ Ext.getCmp(location).add(objects); }
				Ext.getCmp(location).doLayout();
			}


			/* Custom functions */
			var messageFn = {
				alertBox : function(inputMessage){
					Ext.Msg.alert('Error',inputMessage);
				},
				progressBox : function(inputMessage){
					Ext.MessageBox.show({
						msg : inputMessage,
						width : 300,
						wait : true,
						waitConfig : { interval : 200 },
						progress : true
					});
				},
				exit : function(){
					Ext.MessageBox.hide();
				}
			};
			var utilityFn = {
				encodeParams :  function(inputObj){
					var size = Object.keys(inputObj).length;
					if(size > 0){
						var resultString = '?';
						var count = 0;
						for(var key in inputObj){
							var delim = (count < (size-1)) ? '&' : '';
							resultString += key + '=' + inputObj[key] + delim;
							count++;
						}
						return resultString;
					}else{
						return false;
					}
				},
				errorsListHtml : function(inputArray){
					var plural = (inputArray.length == 1) ? '' : 's';
					var errorMessage = '';
						errorMessage += 'Please correct the following issue' + plural + ':';
						errorMessage += '<ol>';
					for(var i=0;i<inputArray.length;i++){
						errorMessage += '<li>';
						errorMessage += inputArray[i];
						errorMessage += '</li>';
					}
						errorMessage += '</ol>';
					return errorMessage;
				},
				dates : {
					doubleDigitMonthDay : function(input){
						var inputAsDate = new Date(input);
						var year = inputAsDate.getFullYear();
						var month = inputAsDate.getMonth()+1;
						var date = inputAsDate.getDate();

						var arrayMonth = (month.toString().length < 2) ? '0' + month : month;
						var arrayDate = (date.toString().length < 2) ? '0' + date : date;

						return [year,arrayMonth,arrayDate];
					},
					daysBetween : function(dateArray){
						if(dateArray.length == 2){
							var startingDate = utilityFn.dates.toMorning(dateArray[0]);
							var endingDate = utilityFn.dates.toMorning(dateArray[1]);
							var difference = (endingDate-startingDate)/86400000;
							return difference;
						}else{
							return false;
						}
					},
					getDateEnds : function(boundaryArray,includeWeekends){
						var startDate = utilityFn.dates.toEvening(boundaryArray[0]);
						var finalDate = boundaryArray[1];
						var dateList = [];

						var currentDate = startDate;
						while(currentDate <= finalDate){
							if(includeWeekends == true){
								dateList.push(utilityFn.dates.toEvening(currentDate));
							}else{
								var dayOfWeek = currentDate.getDay();
								if((dayOfWeek > 0)&&(dayOfWeek < 6)){
									dateList.push(utilityFn.dates.toEvening(currentDate));
								}
							}
							currentDate = currentDate.addDays(1);
						}
						return dateList;
					},
					toMorning : function(input){
						var date = new Date(input);
						date.setHours(0);
						date.setMinutes(0);
						date.setSeconds(1);
						date.setMilliseconds(0);
						return date;
					},
					toEvening : function(input){
						var date = new Date(input);
						date.setHours(23);
						date.setMinutes(59);
						date.setSeconds(59);
						date.setMilliseconds(999);
						return date;
					},
					toISO : function(input){
						var inputAsDate = new Date(input);
					/*	var dateArray = this.doubleDigitMonthDay(inputAsDate);
						var hours = inputAsDate.getHours();
						var minutes = inputAsDate.getMinutes();
						var seconds = inputAsDate.getSeconds();
						var formattedDate = dateArray.join('-');
							formattedDate += 'T';
							formattedDate += hours + ':' + minutes + ':' + seconds + '.000';
							formattedDate += 'Z';
						return formattedDate; // Format: YYYY-MM-DDTHH:MM:SS.SSSZ
					*/
						return inputAsDate.toISOString();
					},
					toSortable : function(input){
						var dateArray = this.doubleDigitMonthDay(new Date(input));
						return dateArray.join('/');
					}
				},
				query : {
					create : function(queryItems){
						var queryStr = '';
						var openingStr = '';
						for(var i=0;i<queryItems.length;i++){
							openingStr += (i == 0) ? '' : '(';
							queryStr += '(';
							queryStr += queryItems[i].key + ' ' + queryItems[i].operand + ' "' + queryItems[i].value + '"';
							queryStr += (i == 0) ? ')' : '))';
							queryStr += (i !== queryItems.length-1) ? ' ' + queryItems[i].operator + ' ' : '';
						}
						return openingStr + queryStr;
					}
				}
			};
			Date.prototype.addDays = function(days){
				// To support the utility function for creating a "dates between" array
				var date = new Date(this.valueOf());
				date.setDate(date.getDate() + days);
				return date;
			}
			Array.prototype.unique = function() {
				var unique = [];
				for(var i=0;i<this.length;i++){
					var current = this[i];
					if(unique.indexOf(current) < 0){ unique.push(current); }
				}
				return unique;
			}
			Array.prototype.trimArray = function() {
				var trimmed = [];
				for(var i=0;i<this.length;i++){
					var current = this[i];
					if(current.length > 0){ trimmed.push(current); }
				}
				return trimmed;
			}

		</script>
		<style>
			body *{
				padding:0;
				margin:0;
			}
			li{
				margin-left:25px;
				padding-bottom:3px;
			}
			textarea{
				width:75%;
				margin:0.5rem;
				padding:0.5rem;
			}
			input[type="text"]{
				background-color:#ffffff;
				color:#000000;
			}
			input[type="text"][readonly]{
				background-color:#efefef;
			}
			input[type="text"][readonly][role="combobox"]{
				background-color:#ffffff;
			}

			.hidden{ display:none; }
			.x-panel-body{ border-width:0; }
			.x-toolbar.x-toolbar-default.x-box-layout-ct{ margin-bottom:20px; }

			#report-selection-container{
				
			}
				#report-selection-container #report-type-body{
					border-width:1px;
					border-color:#0064b9;
					background-color:#22aaff;
					color:#ffffff;
					padding:5px;
					border-radius:15px 15px 0 0;
				}
				#report-selection-container label{
					font-weight:900;
					font-size:18px;
					line-height:18px;
				}

			#report-input-container{
				padding:10px 0 0 0;
				border-bottom:3px solid #1188ff;
			}
				#report-input-container .x-btn.primary.primary{
					background: linear-gradient(#1188ff,#2fa6ff); /* Standard syntax */
						background: -webkit-linear-gradient(#1188ff,#2fa6ff); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#1188ff,#2fa6ff); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#1188ff,#2fa6ff); /* For Firefox 3.6 to 15 */
					border-color:#2266aa;
				}
				#report-input-container .x-btn.primary.primary:hover{
					background: linear-gradient(#1188ff,#006ae1); /* Standard syntax */
						background: -webkit-linear-gradient(#1188ff,#006ae1); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#1188ff,#006ae1); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#1188ff,#006ae1); /* For Firefox 3.6 to 15 */
				}
				#report-input-container #report-input-container-innerCt{
					border-left:3px solid #1188ff;
					padding-left:10px;
					padding-bottom:10px;
				}
				#report-input-container .custom-search-query-value{
					width:75%;
				}
				#report-input-container .custom-search-query-value #CustomQueryField-bodyEl{
					width:inherit !important;
				}
				#QueryBuilderAdd{
					overflow:hidden;
					margin-bottom:10px;
				}
				#QueryBuilderAdd .QuerySetWrapper{
					float:left;
					clear:left;
					width:100%;
					overflow:hidden;
					background-color:#ffffff;
					padding:10px;
				}
				#QueryBuilderAdd .QuerySetWrapper .QueryParamDelete{
					background: linear-gradient(#ce2a1b,#e53120); /* Standard syntax */
						background: -webkit-linear-gradient(#ce2a1b,#e53120); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#ce2a1b,#e53120); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#ce2a1b,#e53120); /* For Firefox 3.6 to 15 */
					border-color:#430d08;
				}
				#QueryBuilderAdd .QuerySetWrapper .QueryParamDelete:hover{
					background: linear-gradient(#ce2a1b,#af2418); /* Standard syntax */
						background: -webkit-linear-gradient(#ce2a1b,#af2418); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#ce2a1b,#af2418); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#ce2a1b,#af2418); /* For Firefox 3.6 to 15 */
				}
				#QueryBuilderAdd .QuerySetWrapper .QueryParamDelete.x-disabled,#QueryBuilderAdd .QuerySetWrapper .QueryParamDelete.x-disabled:hover{
					background: linear-gradient(#d0d0d0,#ededed); /* Standard syntax */
						background: -webkit-linear-gradient(#d0d0d0,#ededed); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#d0d0d0,#ededed); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#d0d0d0,#ededed); /* For Firefox 3.6 to 15 */
					border-color:#430d08;
					cursor:default;
				}
				#QueryBuilderAdd .QuerySetWrapper:nth-of-type(even){
					background-color:#ffffcc;
				}
				#QueryBuilderAdd .QuerySetWrapper > span > div > *{
					float:left;
					margin:0 10px 0 0;
				}
				#QueryBuilderAdd .QuerySetWrapper > span > div > table.x-form-trigger-wrap{
					width:95% !important;
				}
				#QueryBuilderParams{
					clear:both;
				}

			#report-output-container{
				overflow:hidden;
				clear:both;
				padding:10px 0;
				border-bottom:3px solid #77ccff;
			}
				#report-output-container #report-output-container-innerCt{
					border-left:3px solid #77ccff;
					padding-left:10px;
				}
				#report-output-container #burndown-graph,#report-output-container #burndown-panel{
					width:48%;
					float:left;
					padding:2px;
				}
				#report-output-container a.x-btn.x-btn-toolbar.x-box-item.x-toolbar-item{
					background: linear-gradient(#77ccff,#81d6ff); /* Standard syntax */
						background: -webkit-linear-gradient(#77ccff,#81d6ff); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#77ccff,#81d6ff); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#77ccff,#81d6ff); /* For Firefox 3.6 to 15 */
					border:1px solid #1188ff;
					margin:5px;
				}
				#report-output-container a.x-btn.x-btn-toolbar.x-box-item.x-toolbar-item:hover{
					background: linear-gradient(#77ccff,#59aee1); /* Standard syntax */
						background: -webkit-linear-gradient(#77ccff,#59aee1); /* For Safari 5.1 to 6.0 */
						background: -o-linear-gradient(#77ccff,#59aee1); /* For Opera 11.1 to 12.0 */
						background: -moz-linear-gradient(#77ccff,#59aee1); /* For Firefox 3.6 to 15 */
					border:1px solid #1188ff;
				}

			.colWrapper{
				overflow:hidden;
				width:100%;
			}
				.colNarrow{
					float:left;
					width:25%;
				}
				.colMid{
					float:left;
					width:49%;
				}
			.textarea{
				width:85%;
			}
				.textarea #StoryIdList-labelCell{
					width:25px;
					vertical-align:top;
				}
				.textarea textarea{
					min-width:500px;
					min-height:100px;
				}
		</style>
	</head>
	<body class="custom-app"></body>
</html>